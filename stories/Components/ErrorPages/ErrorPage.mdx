import { Meta, Canvas } from '@storybook/addon-docs/blocks';
import * as Stories from './ErrorPage.stories.jsx';

<Meta of={Stories} title="Components/Error pages" />

# Standard error pages

Consistent error pages improve clarity and reduce friction when things go wrong. Use the `ErrorPage` component to display common HTTP error states with clear guidance and next steps.

The error pages and guidance shown here are recommendations. When implementing in your own platform or application, adapt the links (such as "Go to home", "Contact support", or "Status page") to match your actual URLs and support channels.

For static error pages (e.g., for CDN or upstream error handling), it is important to:

- **Include UNDRR analytics code** to track error events and user behavior:
    `<script type="text/javascript" src="https://assets.undrr.org/static/analytics/v1.0.0/google_analytics_enhancements.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>`
- **Include UNDRR critical messaging JavaScript** to ensure users receive important updates or alerts, even on error pages.
    `<script src="https://messaging.undrr.org/src/undrr-messaging.js" defer></script>`

## When to use

- Show a user‑friendly page for common error codes (404, 403, 429, 500, 502, 503, 504)
- Provide calm, actionable messages that explain what happened and what to do next
- Keep headings in sentence case and preserve proper nouns, following our writing guidelines

## Formatting

### 404 not found

<Canvas of={Stories.NotFound404} />

### 403 forbidden

<Canvas of={Stories.Forbidden403} />

### 429 too many requests

<Canvas of={Stories.TooManyRequests429} />

### 502 bad gateway

<Canvas of={Stories.BadGateway502} />

### 503 service unavailable

<Canvas of={Stories.ServiceUnavailable503} />

### 500 internal server error

<Canvas of={Stories.InternalServerError500} />

### 504 gateway timeout

<Canvas of={Stories.GatewayTimeout504} />

### 401 unauthorized

<Canvas of={Stories.Unauthorized401} />

## Challenge pages

Challenge pages are shown when Cloudflare needs to verify a visitor (e.g., CAPTCHA or browser check). They are deliberately designed to look different from error pages so visitors understand they are being verified — not blocked by an error.

### Design approach

The challenge page design follows [Cloudflare's guidance on custom challenge pages](https://developers.cloudflare.com/cloudflare-challenges/challenge-types/challenge-pages/) and UX research on CAPTCHA friction:

- **Neutral background** (`#f2f2f2`) instead of the blue error background — signals "routine checkpoint", not "something broke"
- **Centered, narrower card** with rounded corners and subtle shadow — focuses attention on the verification widget
- **UNDRR logo for trust** — unexpected interstitials can feel like phishing; brand presence reassures visitors
- **Calm, non-error language** — "routine check", not "blocked" or "suspicious"; no technical details shown by default
- **Generous whitespace** — the page should feel unhurried; the Turnstile widget is the sole focus

The Cloudflare Turnstile widget (which replaces `::CAPTCHA_BOX::`) renders at 300 x 65px (normal) or full-width with min 300px (flexible mode). The card is sized to comfortably contain it. Most legitimate visitors pass the managed challenge automatically with no interaction.

### Important constraints

- **Do not** include a `<meta name="referrer">` tag — it breaks the Cloudflare challenge flow
- **Do not** use aggressive language ("blocked", "suspicious", "threat") on verification pages
- The `::CAPTCHA_BOX::` token is **required** in both static HTML templates — Cloudflare replaces it with the actual widget at runtime
- Static templates must not exceed 1.5 MB (Cloudflare limit)

### Design references

- [Cloudflare Turnstile widget configurations](https://developers.cloudflare.com/turnstile/get-started/client-side-rendering/widget-configurations/) — widget sizes, themes, and rendering modes
- [Cloudflare custom challenge pages](https://developers.cloudflare.com/cloudflare-challenges/challenge-types/challenge-pages/) — customization options and constraints
- [Cloudflare additional configuration](https://developers.cloudflare.com/cloudflare-challenges/challenge-types/challenge-pages/additional-configuration/) — CSP restrictions, favicon, and referrer policy warnings
- [CAPTCHA can ruin your UX (Auth0)](https://auth0.com/blog/captcha-can-ruin-your-ux-here-s-how-to-use-it-right/) — friction impact and mitigation strategies
- [Cloudflare Turnstile accessibility (WCAG 2.1 AA)](https://developers.cloudflare.com/turnstile/frequently-asked-questions/) — the widget is WCAG 2.1 Level AA compliant

### Interactive challenge

<Canvas of={Stories.InteractiveChallenge} />

### Managed challenge

<Canvas of={Stories.ManagedChallenge} />

## Content

- Keep the title short and specific to the state
- Explain the situation briefly; avoid blame and technical jargon
- Offer 1–2 clear actions: try again, go home, contact support, or search

## Cloudflare integration

The static HTML templates in this component are designed for use with [Cloudflare Custom Error Pages](https://developers.cloudflare.com/rules/custom-errors/). They include:

- **Deferred asset loading** via JavaScript to bypass Cloudflare's asset bundling limits
- **Cloudflare error tokens** that display request details for debugging and support
- **Client-side URL capture** since Cloudflare doesn't provide a URL token
- **Analytics meta tags** (`vf:page-type`) for tracking error page views

### Available Cloudflare tokens

| Token | Description |
|-------|-------------|
| `::RAY_ID::` | Unique request identifier for support tickets |
| `::CLIENT_IP::` | Visitor's IP address |
| `::GEO::` | Visitor's country/region |
| `::CLOUDFLARE_ERROR_500S_BOX::` | Server error details (5xx errors) |
| `::CLOUDFLARE_ERROR_1000S_BOX::` | Cloudflare-specific error codes |
| `::CAPTCHA_BOX::` | Interactive Challenge / Managed Challenge |
| `::IM_UNDER_ATTACK_BOX::` | Non-Interactive Challenge (JS Challenge) |

See [Cloudflare error tokens documentation](https://developers.cloudflare.com/rules/custom-errors/reference/error-tokens/) for full details.

### Analytics meta tag

Each static template includes a `vf:page-type` meta tag for analytics tracking:

```html
<meta name="vf:page-type" content="category;404" />
```

### Client-side URL capture

Since Cloudflare doesn't provide a URL token, each template includes JavaScript that appends the current URL to the error details at runtime.

### Adapting for other platforms

The static HTML templates include comments explaining which parts are Cloudflare-specific. To adapt for other platforms (Varnish, nginx, AWS CloudFront, etc.):

1. Replace Cloudflare tokens with your platform's equivalent variables
2. Update the JavaScript loader if your CDN has different requirements
3. Adjust the inline CSS if needed for your design system

## Static HTML templates

For static error pages (e.g., for CDN or upstream error handling), include these scripts:

```html
<!-- UNDRR analytics - tracks error events -->
<script type="text/javascript"
  src="https://assets.undrr.org/static/analytics/v1.0.0/google_analytics_enhancements.js"
  crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<!-- UNDRR critical messaging - displays important alerts -->
<script src="https://messaging.undrr.org/src/undrr-messaging.js" defer></script>
```

See the [static HTML examples](https://github.com/unisdr/undrr-mangrove/tree/main/stories/Components/ErrorPages/static) for complete templates.

## CDN links

Use these static HTML pages directly from the CDN when integrating with CDNs or upstream error handlers:

### Cloudflare custom error page types

| Cloudflare Setting | Template | Required Token | Description |
|-------------------|----------|----------------|-------------|
| 500 class errors | `5xx.html` | `::CLOUDFLARE_ERROR_500S_BOX::` | Covers all 5xx server errors with one page |
| IP/Country challenge | `challenge.html` | `::CAPTCHA_BOX::` | Interactive challenge for visitors based on IP or country |
| Managed challenge / I'm Under Attack Mode | `managed-challenge.html` | `::CAPTCHA_BOX::` | Managed challenge, returns 403 status |
| 1000 class errors | — | `::CLOUDFLARE_ERROR_1000S_BOX::` | Cloudflare-specific errors (use 5xx.html or create custom) |

### CDN links for Cloudflare

**Cloudflare-specific templates:**
```text
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/5xx.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/challenge.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/managed-challenge.html
```

**Individual error pages** (for platforms that support per-code configuration):
```text
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/401.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/403.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/404.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/429.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/500.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/502.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/503.html
https://assets.undrr.org/static/mangrove/latest/assets/error-pages/504.html
```

## CSS and JS references

- CSS: included in the global component bundle via `stories/assets/scss/_components.scss`
- Inline CSS: static templates include critical CSS for immediate rendering
- JS: deferred loading script fetches full CSS and analytics from CDN

## Interactions

- Primary action uses the solid button style; secondary action uses the outlined style
- Optional search field helps users recover from 404 states
- Request details (Ray ID, IP, location) help support teams diagnose issues

## Changelog

- 1.3.0 — Challenge pages now use neutral background and teal accent to differentiate from error pages ([#2615](https://gitlab.com/undrr/web-backlog/-/issues/2615))
- 1.2.0 — Added 401, 500, 504, 5xx, challenge, managed-challenge static templates; added URL via client-side JS; added `vf:page-type` meta tags for analytics ([#2556](https://gitlab.com/undrr/web-backlog/-/issues/2556))
- 1.1.0 — Added Cloudflare integration with error tokens and deferred asset loading ([#2556](https://gitlab.com/undrr/web-backlog/-/issues/2556))
- 1.0.0 — Added standard error pages component and examples
